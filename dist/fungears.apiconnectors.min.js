/*! GearsApiConnectorsJS - version: 0.1.5 - revision: 20130919
    A cross-device, cross-platform client framework written in JavaScript and designed to make connecting to our gamification engine easy.
    Author: Fungears <support@fungears.com> (http://fungears.com)
    Repository: https://github.com/Fungears/GearsApiConnectors-JS
    Licence: BSD-3-Clause (http://opensource.org/licenses/BSD-3-Clause) */
var fungears;!function(a){!function(){String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return this.slice(0,a.length)===a}),"function"!=typeof String.prototype.format&&(String.prototype.format=function(){for(var a=[],b=0;b<arguments.length-0;b++)a[b]=arguments[b+0];return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})}),Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}),Object.keys||(Object.keys=function(){"use strict";var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var f,g,h=[];for(f in e)a.call(e,f)&&h.push(f);if(b)for(g=0;d>g;g++)a.call(e,c[g])&&h.push(c[g]);return h}}())}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));var fungears;!function(a){!function(a){var b,c,d,e=!1,f=!1,g=function(){};if(Function.prototype.bind&&("object"==typeof console||"function"==typeof console)&&"object"==typeof console.log)try{["log","info","warn","error","assert","dir","clear","profile","profileEnd"].forEach(function(a){console[a]=this.call(console[a],console)},Function.prototype.bind)}catch(h){f=!0}b=function(){for(var a=[],b=0;b<arguments.length-0;b++)a[b]=arguments[b+0];try{if("undefined"!=typeof console&&"function"==typeof console.log)if(window.opera)for(var c=0;c<a.length;)console.log("Item "+(c+1)+": "+a[c]),c++;else 1===Array.prototype.slice.call(a).length&&"string"==typeof Array.prototype.slice.call(a)[0]?console.log(Array.prototype.slice.call(a).toString()):console.log(Array.prototype.slice.call(a));else Function.prototype.bind&&!f||"undefined"==typeof console||"object"!=typeof console.log||Function.prototype.call.call(console.log,console,Array.prototype.slice.call(a))}catch(d){}},c=function(a){throw a},d={argumentNotNull:function(a,b){if(void 0===a||null===a)throw new Error("ArgumentNull exception : "+b+" is null")},argumentNotNullOrEmpty:function(a,b){if(void 0===a||null===a||""===a)throw new Error("ArgumentNull exception : "+b+" is null or empty")},argumentIsNumber:function(a,b){if(void 0===a||null===a||"number"!=typeof a)throw new Error("Argument exception : "+b+" is not a number")},argumentIsOptionalNumber:function(a,b){if(void 0!==a&&(null===a||"number"!=typeof a))throw new Error("Argument exception : "+b+" is not an optional number")},argumentIsFunction:function(a,b){if(void 0===a||null===a||"function"!=typeof a)throw new Error("Argument exception : "+b+" is not a function")},argumentIsDefined:function(a,b){if(void 0===a)throw new Error("Argument exception : "+b+" is undefined")}},a.system={version:"0.1.5",noop:g,log:g,error:g,debug:function(a){return e=a,e&&(this.log=b,this.error=c,this.log("Fungears ApiConnectors - Debug mode enabled")),e},guard:d}}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));var fungears;!function(a){!function(a){function b(b,c,e,f){return"undefined"==typeof f&&(f=d.JSON),a.system.guard.argumentNotNullOrEmpty(b,"url"),a.system.guard.argumentNotNullOrEmpty(c,"httpMethod"),a.system.log("Executing ajax call ({0} : {1})".format(c,b)),$.ajax({url:b,type:c.toUpperCase(),data:f===d.FORM_URLENCODED?e:JSON.stringify(e),contentType:f,dataType:"json"})}var c={GET:"GET",POST:"POST"},d={JSON:"application/json; charset=utf-8",FORM_URLENCODED:"application/x-www-form-urlencoded; charset=utf-8"};a.http={get:function(a,d){return b(a,c.GET,d)},postJson:function(d,e){return a.system.guard.argumentNotNull(e,"data"),b(d,c.POST,e)},postForm:function(e,f){return a.system.guard.argumentNotNull(f,"data"),b(e,c.POST,f,d.FORM_URLENCODED)}}}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));var fungears;!function(a){!function(a){var b=function(){function a(a,b){this.subscriptionId=a,this.func=b}return a}();a.EventSubscription=b;var c=function(){function a(){this.subUid=0,this.subscriptions={}}return a.prototype.subscribe=function(a,c){this.subscriptions[a]||(this.subscriptions[a]=[]);var d=new b(++this.subUid,c);return this.subscriptions[a].push(d),d.subscriptionId},a.prototype.unsubscribe=function(a){var b,c,d;for(b in this.subscriptions)if(this.subscriptions[b])for(c=0,d=this.subscriptions[b].length;d>c;c++)if(this.subscriptions[b][c].subscriptionId===a)return this.subscriptions[b].splice(c,1),!0;return!1},a.prototype.publish=function(a,b){var c=this;return this.subscriptions[a]?(setTimeout(function(){for(var d=c.subscriptions[a],e=d?d.length:0;e--;)d[e].func(b)},0),!0):!1},a.prototype.reset=function(){this.subUid=0,this.subscriptions={}},a}();a.EventAggregator=c;var d=new c;a.pubSub={events:{gameAction:"fungears:gameAction",gameNotification:"fungears:gameNotification",levelChanged:"fungears:gameNotification:levelChanged",achievementReceived:"fungears:gameNotification:achievementReceived",currencyReceived:"fungears:gameNotification:currencyReceived",pointReceived:"fungears:gameNotification:pointReceived",goodReceived:"fungears:gameNotification:goodReceived",engineError:"fungears:gameNotification:error",engineNotice:"fungears:gameNotification:notice"},publish:function(a,b){return d.publish(a,b)},subscribe:function(a,b){return d.subscribe(a,b)},unsubscribe:function(a){return d.unsubscribe(a)},includesIn:function(a){a.subscribe=d.subscribe,a.unsubscribe=d.unsubscribe,a.publish=d.publish},reset:function(){return d.reset()}}}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));var fungears;!function(a){!function(a){function b(a){if(!a)return null;var b=a.trim();123===b.charCodeAt(0)&&(b=b.slice(1,-1));var c=b.split(":");if(!c||2!==c.length||!c[0]||!c[1])return null;var d={eventTypes:c[0].toLowerCase().trim(),actionKey:c[1].trim()};return d}var c="data-fungears",d=function(){function a(a){"undefined"==typeof a&&(a=c),this.bindingName=a||c}return a.prototype.getBinding=function(a){var c=this.getBindingString(a);return c?b(c):null},a.prototype.getBindingString=function(a){return a.getAttribute?a.getAttribute(this.bindingName):""},a}();a.BindingProvider=d}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));var fungears;!function(a){!function(a){var b={apiUrl:"https://gears.fungears.io/games",authUrl:null,gameId:null,oauth2:{grant_type:"client_credentials",client_id:null,client_secret:null,scope:null}},c={},d=null,e=function(){function e(){}return e.prototype.init=function(a){c=$.extend(!0,{},b,a),this.setPrefilter()},e.prototype.postEvent=function(b){return a.http.postJson("{0}/games/{1}/events".format(c.apiUrl,c.gameId),b)},e.prototype.refreshAccessToken=function(){return a.http.postForm(c.authUrl,c.oauth2).done(function(a){d=a.access_token})},e.prototype.setPrefilter=function(){var b=this;$.ajaxPrefilter(function(e,f,g){var h=$.Deferred();if(!e.refreshRequest&&(e.url.startsWith(c.apiUrl)||e.url===c.authUrl))return d&&(e.headers={Authorization:"Bearer "+d}),a.system.log("ApiConnector AjaxPrefilter",e,f,g),g.done(function(a){h.resolve(a)}),g.fail(function(){var a=Array.prototype.slice.call(arguments);401===g.status?b.refreshAccessToken().then(function(){var a=$.extend({},f,{refreshRequest:!0,headers:{Authorization:"Bearer "+d}});$.ajax(a).then(h.resolve,h.reject)},function(){h.rejectWith(g,a)}):h.rejectWith(g,a)}),h.promise(g)})},e}();a.Api=e}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));var fungears;!function(a){!function(a){var b={defaultBindingName:"data-fungears",eventTypes:"click dblclick",delegatedTarget:document,gamerId:null,gamerApiKey:null,apiOptions:{}},c={0:void 0,1:a.pubSub.events.levelChanged,2:a.pubSub.events.achievementReceived,3:a.pubSub.events.currencyReceived,4:a.pubSub.events.pointReceived,5:a.pubSub.events.goodReceived,70:a.pubSub.events.engineError,71:a.pubSub.events.engineNotice},d=function(){function d(){this.subscriptions=[],this.disposed=!1,this.api=new a.Api}return d.prototype.init=function(c){this.settings=$.extend(!0,{},b,c),this.validateSettings(),this.api.init(this.settings.apiOptions),this.bindingProvider=new a.BindingProvider(this.settings.defaultBindingName),this.subscriptions.push(a.pubSub.subscribe(a.pubSub.events.gameAction,this.handleGameAction.bind(this))),this.subscriptions.push(a.pubSub.subscribe(a.pubSub.events.gameNotification,this.handleGameNotification.bind(this)))},d.prototype.listen=function(){var b=this.bindingProvider,c=$("["+b.bindingName+"]");return c&&c.length?(c.each(function(){var c=$(this),d=b.getBinding(this);d&&c.on(d.eventTypes,function(){a.pubSub.publish(a.pubSub.events.gameAction,d.actionKey)})}),!0):!1},d.prototype.delegatedListen=function(){var b=this.settings.eventTypes.toLowerCase(),c=this.bindingProvider;return $(this.settings.delegatedTarget).on(this.settings.eventTypes,"["+c.bindingName+"]",function(d){if(-1===b.indexOf(d.type))return!0;var e=c.getBinding(this);return a.pubSub.publish(a.pubSub.events.gameAction,e.actionKey),!0}),!0},d.prototype.listenTo=function(b,c,d){return b&&b.length&&c?(b.on(c,function(){a.pubSub.publish(a.pubSub.events.gameAction,d)}),!0):!1},d.prototype.onGameAction=function(b,c){return"undefined"==typeof c&&(c=this),this.on(a.pubSub.events.gameAction,b,c)},d.prototype.onGameNotification=function(b,c){return"undefined"==typeof c&&(c=this),this.on(a.pubSub.events.gameNotification,b,c)},d.prototype.onLevelChanged=function(b,c){return"undefined"==typeof c&&(c=this),this.on(a.pubSub.events.levelChanged,b,c)},d.prototype.onAchievementReceived=function(b,c){return"undefined"==typeof c&&(c=this),this.on(a.pubSub.events.achievementReceived,b,c)},d.prototype.onCurrencyReceived=function(b,c){return"undefined"==typeof c&&(c=this),this.on(a.pubSub.events.currencyReceived,b,c)},d.prototype.onPointReceived=function(b,c){return"undefined"==typeof c&&(c=this),this.on(a.pubSub.events.pointReceived,b,c)},d.prototype.onGoodReceived=function(b,c){return"undefined"==typeof c&&(c=this),this.on(a.pubSub.events.goodReceived,b,c)},d.prototype.trigger=function(b){return b?a.pubSub.publish(a.pubSub.events.gameAction,b):!1},d.prototype.dispose=function(){if(!this.disposed){var b=0;for(b;b<this.subscriptions.length;b++)a.pubSub.unsubscribe(this.subscriptions[b]);this.subscriptions=[],this.api=null,this.bindingProvider=null,this.disposed=!0}},d.prototype.on=function(b,c,d){return"undefined"==typeof d&&(d=this),b&&c&&"function"==typeof c?(this.subscriptions.push(a.pubSub.subscribe(b,c.bind(d))),!0):!1},d.prototype.handleGameAction=function(b){a.system.log("Handling event",a.pubSub.events.gameAction,b),this.api.postEvent({gamerId:this.settings.gamerId,gamerApiKey:this.settings.gamerApiKey,actionKey:b}).done(function(b){a.pubSub.publish(a.pubSub.events.gameNotification,b)}).fail(function(b,c,d){a.system.log("Api post event",a.pubSub.events.gameAction,b,c,d)})},d.prototype.handleGameNotification=function(b){if(a.system.log("Handling event",a.pubSub.events.gameNotification,b),b){var d=Array.isArray(b)?b:[b];$.each(d,function(b,d){c[d.type]&&a.pubSub.publish(c[d.type],d)})}},d.prototype.validateSettings=function(){this.settings||this.throwValidationError("null object"),this.settings.apiOptions||this.throwValidationError("apiOptions is null or undefined"),(void 0===this.settings.gamerId||null===this.settings.gamerId)&&this.throwValidationError("gamerId is null or undefined"),this.settings.gamerApiKey||this.throwValidationError("gamerApiKey is null or undefined")},d.prototype.throwValidationError=function(a){throw new Error("Listener settings error : {0}".format(a))},d}();a.Listener=d}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));
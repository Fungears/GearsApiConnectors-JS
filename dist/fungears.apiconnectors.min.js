/*! GearsApiConnectorsJS - version: 0.1.1 - revision: 20130830
    A cross-device, cross-platform client framework written in JavaScript and designed to make connecting to our gamification engine easy.
    Author: Fungears <support@fungears.com> (http://fungears.com)
    Repository: https://github.com/Fungears/GearsApiConnectors-JS
    Licence: BSD-3-Clause (http://opensource.org/licenses/BSD-3-Clause) */
var fungears;!function(a){!function(){String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return this.slice(0,a.length)===a}),"function"!=typeof String.prototype.format&&(String.prototype.format=function(){for(var a=[],b=0;b<arguments.length-0;b++)a[b]=arguments[b+0];return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})}),Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}),Object.keys||(Object.keys=function(){"use strict";var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var f,g,h=[];for(f in e)a.call(e,f)&&h.push(f);if(b)for(g=0;d>g;g++)a.call(e,c[g])&&h.push(c[g]);return h}}())}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));var fungears;!function(a){!function(a){var b,c,d,e=!1,f=!1,g=function(){};if(Function.prototype.bind&&("object"==typeof console||"function"==typeof console)&&"object"==typeof console.log)try{["log","info","warn","error","assert","dir","clear","profile","profileEnd"].forEach(function(a){console[a]=this.call(console[a],console)},Function.prototype.bind)}catch(h){f=!0}b=function(){for(var a=[],b=0;b<arguments.length-0;b++)a[b]=arguments[b+0];try{if("undefined"!=typeof console&&"function"==typeof console.log)if(window.opera)for(var c=0;c<a.length;)console.log("Item "+(c+1)+": "+a[c]),c++;else 1===Array.prototype.slice.call(a).length&&"string"==typeof Array.prototype.slice.call(a)[0]?console.log(Array.prototype.slice.call(a).toString()):console.log(Array.prototype.slice.call(a));else Function.prototype.bind&&!f||"undefined"==typeof console||"object"!=typeof console.log||Function.prototype.call.call(console.log,console,Array.prototype.slice.call(a))}catch(d){}},c=function(a){throw a},d={argumentNotNull:function(a,b){if(void 0===a||null===a)throw new Error("ArgumentNull exception : "+b+" is null")},argumentNotNullOrEmpty:function(a,b){if(void 0===a||null===a||""===a)throw new Error("ArgumentNull exception : "+b+" is null or empty")},argumentIsNumber:function(a,b){if(void 0===a||null===a||"number"!=typeof a)throw new Error("Argument exception : "+b+" is not a number")},argumentIsOptionalNumber:function(a,b){if(void 0!==a&&(null===a||"number"!=typeof a))throw new Error("Argument exception : "+b+" is not an optional number")},argumentIsFunction:function(a,b){if(void 0===a||null===a||"function"!=typeof a)throw new Error("Argument exception : "+b+" is not a function")},argumentIsDefined:function(a,b){if(void 0===a)throw new Error("Argument exception : "+b+" is undefined")}},a.system={version:"0.1.1",noop:g,log:g,error:g,debug:function(a){return e=a,e&&(this.log=b,this.error=c,this.log("Fungears ApiConnectors - Debug mode enabled")),e},guard:d}}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));var fungears;!function(a){!function(a){function b(b,c,e,f){return"undefined"==typeof f&&(f=d.JSON),a.system.guard.argumentNotNullOrEmpty(b,"url"),a.system.guard.argumentNotNullOrEmpty(c,"httpMethod"),a.system.log("Executing ajax call ({0} : {1})".format(c,b)),$.ajax({url:b,type:c.toUpperCase(),data:f===d.FORM_URLENCODED?e:JSON.stringify(e),contentType:f,dataType:"json"})}var c={GET:"GET",POST:"POST"},d={JSON:"application/json; charset=utf-8",FORM_URLENCODED:"application/x-www-form-urlencoded; charset=utf-8"};a.http={get:function(a,d){return b(a,c.GET,d)},postJson:function(d,e){return a.system.guard.argumentNotNull(e,"data"),b(d,c.POST,e)},postForm:function(e,f){return a.system.guard.argumentNotNull(f,"data"),b(e,c.POST,f,d.FORM_URLENCODED)}}}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));var fungears;!function(a){!function(a){var b=function(){function a(a,b){this.subscriptionId=a,this.func=b}return a}();a.EventSubscription=b;var c=function(){function a(){this.subUid=0,this.subscriptions={}}return a.prototype.subscribe=function(a,c){this.subscriptions[a]||(this.subscriptions[a]=[]);var d=new b(++this.subUid,c);return this.subscriptions[a].push(d),d.subscriptionId},a.prototype.unsubscribe=function(a){var b,c,d;for(b in this.subscriptions)if(this.subscriptions[b])for(c=0,d=this.subscriptions[b].length;d>c;c++)if(this.subscriptions[b][c].subscriptionId===a)return this.subscriptions[b].splice(c,1),!0;return!1},a.prototype.publish=function(a,b){var c=this;return this.subscriptions[a]?(setTimeout(function(){for(var d=c.subscriptions[a],e=d?d.length:0;e--;)d[e].func(b)},0),!0):!1},a.prototype.reset=function(){this.subUid=0,this.subscriptions={}},a}();a.EventAggregator=c;var d=new c;a.pubSub={events:{gameAction:"fungears:gameAction",gameNotification:"fungears:gameNotification"},publish:function(a,b){return d.publish(a,b)},subscribe:function(a,b){return d.subscribe(a,b)},unsubscribe:function(a){return d.unsubscribe(a)},includesIn:function(a){a.subscribe=d.subscribe,a.unsubscribe=d.unsubscribe,a.publish=d.publish}}}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));var fungears;!function(a){!function(a){function b(a){if(!a)return null;var b=a.trim();123===b.charCodeAt(0)&&(b=b.slice(1,-1));var c=b.split(":");if(!c||2!==c.length||!c[0]||!c[1])return null;var d={eventTypes:c[0].trim(),actionKey:c[1].trim()};return d}var c="data-fungears";a.bindingProvider={bindingName:c,getBinding:function(c){var d=a.bindingProvider.getBindingString(c);return d?b(d):null},getBindingString:function(b){return b.getAttribute?b.getAttribute(a.bindingProvider.bindingName):""}}}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));var fungears;!function(a){!function(a){var b={apiUrl:"https://gears.api.fungears.com/games",authUrl:null,gameId:null,oauth2:{grant_type:"client_credentials",client_id:null,client_secret:null,scope:null}},c={},d=null,e=function(){function e(){}return e.prototype.init=function(a){c=$.extend(!0,{},b,a),this.setPrefilter()},e.prototype.postEvent=function(b){return a.http.postJson("{0}/games/{1}/events".format(c.apiUrl,c.gameId),b)},e.prototype.refreshAccessToken=function(){return a.http.postForm(c.authUrl,c.oauth2).done(function(a){d=a.access_token})},e.prototype.setPrefilter=function(){var b=this;$.ajaxPrefilter(function(e,f,g){var h=$.Deferred();if(!e.refreshRequest&&(e.url.startsWith(c.apiUrl)||e.url===c.authUrl))return d&&(e.headers={Authorization:"Bearer "+d}),a.system.log("ApiConnector AjaxPrefilter",e,f,g),g.done(function(a){h.resolve(a)}),g.fail(function(){var a=Array.prototype.slice.call(arguments);401===g.status?b.refreshAccessToken().then(function(){var a=$.extend({},f,{refreshRequest:!0,headers:{Authorization:"Bearer "+d}});$.ajax(a).then(h.resolve,h.reject)},function(){h.rejectWith(g,a)}):h.rejectWith(g,a)}),h.promise(g)})},e}();a.Api=e}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));var fungears;!function(a){!function(a){var b={defaultBindingAttributeName:"data-fungears",apiOptions:{},gamerId:null,gamerApiKey:null},c=function(){function c(){this.api=new a.Api}return c.prototype.init=function(c){this.settings=$.extend(!0,{},b,c),this.validateSettings(),this.api.init(this.settings.apiOptions),a.pubSub.subscribe(a.pubSub.events.gameAction,this.handleGameAction.bind(this)),a.pubSub.subscribe(a.pubSub.events.gameNotification,this.handleGameNotification.bind(this))},c.prototype.listen=function(){var b=$("["+a.bindingProvider.bindingName+"]");return b&&b.length?(b.each(function(){var b=$(this),c=a.bindingProvider.getBinding(this);c&&b.on(c.eventTypes,function(){a.pubSub.publish(a.pubSub.events.gameAction,c.actionKey)})}),!0):!1},c.prototype.listenTo=function(b,c,d){return b&&b.length&&c?(b.on(c,function(){a.pubSub.publish(a.pubSub.events.gameAction,d)}),!0):!1},c.prototype.onGameAction=function(b,c){return"undefined"==typeof c&&(c=this),b&&"function"==typeof b?(a.pubSub.subscribe(a.pubSub.events.gameAction,b.bind(c)),!0):!1},c.prototype.onGameNotification=function(b,c){return"undefined"==typeof c&&(c=this),b&&"function"==typeof b?(a.pubSub.subscribe(a.pubSub.events.gameNotification,b.bind(c)),!0):!1},c.prototype.handleGameAction=function(b,c){a.system.log("Handling event",a.pubSub.events.gameAction,c),this.api.postEvent({gamerId:this.settings.gamerId,gamerApiKey:this.settings.gamerApiKey,actionKey:c}).done(function(b){a.pubSub.publish(a.pubSub.events.gameNotification,b)}).fail(function(b,c,d){a.system.log("Api post event",a.pubSub.events.gameAction,b,c,d)})},c.prototype.handleGameNotification=function(b,c){a.system.log("Handling event",a.pubSub.events.gameNotification,c)},c.prototype.validateSettings=function(){this.settings||this.throwValidationError("null object"),this.settings.apiOptions||this.throwValidationError("apiOptions is null or undefined"),(void 0===this.settings.gamerId||null===this.settings.gamerId)&&this.throwValidationError("gamerId is null or undefined"),this.settings.gamerApiKey||this.throwValidationError("gamerApiKey is null or undefined")},c.prototype.throwValidationError=function(a){throw new Error("Listener settings error : {0}".format(a))},c}();a.Listener=c}(a.connectors||(a.connectors={})),a.connectors}(fungears||(fungears={}));